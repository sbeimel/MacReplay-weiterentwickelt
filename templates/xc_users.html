{% extends "base.html" %}

{% block title %}XC API Users - MacReplay{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-users me-2"></i>
                    Xtream Codes API Users
                </h2>
                <div class="text-muted mt-1">Manage users who can access streams via XC API</div>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="ti ti-plus me-1"></i>
                    Add User
                </button>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        
        <!-- XC API Status -->
        <div class="row row-cards mb-3">
            <div class="col-12">
                <div class="alert alert-{{ 'success' if settings.get('xc api enabled') == 'true' else 'warning' }}">
                    <div class="d-flex">
                        <div><i class="ti ti-{{ 'check' if settings.get('xc api enabled') == 'true' else 'alert-circle' }} icon alert-icon"></i></div>
                        <div>
                            <h4 class="alert-title">XC API Status: {{ 'Enabled' if settings.get('xc api enabled') == 'true' else 'Disabled' }}</h4>
                            <div class="text-muted">
                                {% if settings.get('xc api enabled') == 'true' %}
                                    XC API is active. Users can access streams at: <code>http://{{ request.host }}/player_api.php</code><br>
                                    <small>Example URL for clients: <code>http://{{ request.host }}/player_api.php?username=USER&password=PASS</code></small>
                                {% else %}
                                    XC API is disabled. Enable it in Settings to allow users to connect.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users List -->
        <div class="row row-cards">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Users</h3>
                    </div>
                    <div class="card-body">
                        <div id="usersList">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId">
                <div class="mb-3">
                    <label class="form-label required">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label required">Password</label>
                    <input type="text" class="form-control" id="password" required>
                    <small class="form-hint">User will use this to authenticate</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Max Connections</label>
                    <input type="number" class="form-control" id="maxConnections" value="1" min="1" max="10">
                    <small class="form-hint">Maximum simultaneous devices</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Expires At</label>
                    <input type="date" class="form-control" id="expiresAt">
                    <small class="form-hint">Leave empty for no expiration</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Allowed Portals</label>
                    <select class="form-select" id="allowedPortals" multiple size="5">
                        <!-- Will be populated dynamically -->
                    </select>
                    <small class="form-hint">Leave empty to allow all portals</small>
                </div>
                <div class="mb-3">
                    <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enabled" checked>
                        <span class="form-check-label">Enabled</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let userModal;
let allPortals = [];

document.addEventListener('DOMContentLoaded', function() {
    userModal = new bootstrap.Modal(document.getElementById('userModal'));
    loadUsers();
    loadPortals();
});

function loadPortals() {
    fetch('/portals', {credentials: 'same-origin'})
        .then(res => res.text())
        .then(html => {
            // Parse portals from the response (simplified)
            // In production, you'd want a dedicated API endpoint
            allPortals = [];
        });
}

function loadUsers() {
    fetch('/xc-users/list', {credentials: 'same-origin'})
        .then(res => res.json())
        .then(data => displayUsers(data.users || []))
        .catch(err => {
            console.error('Error:', err);
            document.getElementById('usersList').innerHTML = 
                '<div class="alert alert-danger">Error loading users</div>';
        });
}

function displayUsers(users) {
    const container = document.getElementById('usersList');
    
    if (!users || users.length === 0) {
        container.innerHTML = '<div class="empty"><p class="empty-title">No users yet</p><p class="empty-subtitle">Click "Add User" to create your first XC API user</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-vcenter">';
    html += '<thead><tr><th>Username</th><th>Password</th><th>Status</th><th>Connections</th><th>Expires</th><th>Actions</th></tr></thead><tbody>';
    
    users.forEach(user => {
        const statusClass = user.enabled ? 'success' : 'secondary';
        const statusText = user.enabled ? 'Active' : 'Disabled';
        
        html += `
            <tr>
                <td><strong>${user.username}</strong></td>
                <td><code>${user.password}</code></td>
                <td><span class="badge bg-${statusClass}-lt">${statusText}</span></td>
                <td>
                    <span class="badge bg-${user.active_connections > 0 ? 'primary' : 'secondary'}-lt">
                        ${user.active_connections}/${user.max_connections}
                    </span>
                </td>
                <td>${user.expires_at || 'Never'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick='editUser(${JSON.stringify(user)})' title="Edit">
                            <i class="ti ti-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}', '${user.username}')" title="Delete">
                            <i class="ti ti-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function showAddUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add User';
    document.getElementById('userId').value = '';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('maxConnections').value = '1';
    document.getElementById('expiresAt').value = '';
    document.getElementById('enabled').checked = true;
    document.getElementById('username').disabled = false;
    document.getElementById('password').disabled = false;
    userModal.show();
}

function editUser(user) {
    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('userId').value = user.id;
    document.getElementById('username').value = user.username;
    document.getElementById('password').value = user.password;
    document.getElementById('maxConnections').value = user.max_connections;
    document.getElementById('expiresAt').value = user.expires_at || '';
    document.getElementById('enabled').checked = user.enabled;
    document.getElementById('username').disabled = true;
    document.getElementById('password').disabled = true;
    userModal.show();
}

function saveUser() {
    const userId = document.getElementById('userId').value;
    const isEdit = userId !== '';
    
    const data = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        max_connections: parseInt(document.getElementById('maxConnections').value),
        expires_at: document.getElementById('expiresAt').value,
        enabled: document.getElementById('enabled').checked,
        allowed_portals: []
    };
    
    if (isEdit) {
        data.user_id = userId;
    }
    
    const url = isEdit ? '/xc-users/update' : '/xc-users/add';
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            userModal.hide();
            loadUsers();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error saving user');
    });
}

function deleteUser(userId, username) {
    if (!confirm(`Delete user "${username}"?`)) {
        return;
    }
    
    fetch('/xc-users/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({user_id: userId})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            loadUsers();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error deleting user');
    });
}
</script>
{% endblock %}
