{% extends "base.html" %}

{% block title %}Portal EPG - MacReplay{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-calendar me-2"></i>
                    Portal EPG
                </h2>
                <div class="text-muted mt-1">Electronic Program Guide from your IPTV providers</div>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="refreshEPG(this)">
                    <i class="ti ti-refresh me-1"></i>Refresh EPG
                </button>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#status-tab" type="button">
                    <i class="ti ti-antenna me-1"></i>Portal Status
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mapping-tab" type="button">
                    <i class="ti ti-link me-1"></i>EPG Mapping
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fallback-tab" type="button">
                    <i class="ti ti-cloud-download me-1"></i>EPG Fallback
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Portal Status Tab -->
            <div class="tab-pane fade show active" id="status-tab" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Portal EPG Status</h3>
                    </div>
                    <div class="card-body">
                        <div id="portalEPGStatus">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title"><i class="ti ti-info-circle me-2"></i>XMLTV Endpoint</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">Use this URL in your IPTV player (Plex, Jellyfin, etc.):</p>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="xmltvUrl" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyXmltvUrl()">
                                <i class="ti ti-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- EPG Mapping Tab -->
            <div class="tab-pane fade" id="mapping-tab" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">EPG ID Mapping</h3>
                        <div class="card-subtitle">Map channels to custom EPG IDs or use fallback</div>
                        <div class="card-actions">
                            <button class="btn btn-outline-primary btn-sm" onclick="applyFallbackToAll(this)">
                                <i class="ti ti-cloud-download me-1"></i>
                                Apply Fallback to All (No Portal EPG)
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="channelSearch" placeholder="Search channels...">
                        </div>
                        <div id="epgMapping">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- EPG Fallback Tab -->
            <div class="tab-pane fade" id="fallback-tab" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="ti ti-cloud-download me-2"></i>EPG Fallback Settings</h3>
                        <div class="card-subtitle">Use epgshare01.online as fallback for channels without EPG</div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="fallbackEnabled">
                                        <span class="form-check-label">Enable EPG Fallback</span>
                                    </label>
                                    <small class="form-hint">When enabled, channels without portal EPG will use data from epgshare01.online</small>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">Fallback Countries</label>
                                    <input type="text" class="form-control" id="fallbackCountries" placeholder="DE, NL, UK, US">
                                    <small class="form-hint">Comma-separated country codes</small>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveFallbackSettings()">
                            <i class="ti ti-device-floppy me-1"></i>Save Settings
                        </button>
                        
                        <hr class="my-4">
                        
                        <div class="alert alert-info">
                            <h4 class="alert-title"><i class="ti ti-info-circle me-2"></i>Available Country Codes</h4>
                            <div class="small">
                                <strong>Europe:</strong> DE, AT, CH, NL, BE, UK, FR, ES, IT, PL, TR, PT, SE, NO, DK, FI, GR, RO, HU, CZ, SK, HR, RS, BG, IE<br>
                                <strong>Americas:</strong> US, CA, BR, MX, AR<br>
                                <strong>Asia/Pacific:</strong> AU, NZ, JP, KR, IN<br>
                                <strong>Other:</strong> IL, ZA
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allChannels = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set XMLTV URL
    document.getElementById('xmltvUrl').value = window.location.origin + '/xmltv';
    
    loadPortalEPGStatus();
    loadFallbackSettings();
    
    // Load mapping tab when clicked
    document.querySelector('[data-bs-target="#mapping-tab"]').addEventListener('shown.bs.tab', loadEPGMapping);
    
    // Search filter
    document.getElementById('channelSearch').addEventListener('input', filterChannels);
});

function copyXmltvUrl() {
    const input = document.getElementById('xmltvUrl');
    navigator.clipboard.writeText(input.value);
    const btn = event.target.closest('button');
    btn.innerHTML = '<i class="ti ti-check"></i>';
    setTimeout(() => btn.innerHTML = '<i class="ti ti-copy"></i>', 1500);
}

function loadPortalEPGStatus() {
    fetch('/epg/portal-status', {credentials: 'same-origin'})
        .then(res => res.json())
        .then(data => displayPortalEPGStatus(data))
        .catch(err => {
            console.error('Error:', err);
            document.getElementById('portalEPGStatus').innerHTML = 
                '<div class="alert alert-danger">Error loading portal EPG status</div>';
        });
}

function displayPortalEPGStatus(portals) {
    const container = document.getElementById('portalEPGStatus');
    
    if (!portals || portals.length === 0) {
        container.innerHTML = '<div class="empty"><p class="empty-title">No portals configured</p></div>';
        return;
    }
    
    let html = '<div class="row">';
    portals.forEach(portal => {
        const hasEPG = portal.has_epg && portal.epg_channel_count > 0;
        const statusClass = hasEPG ? 'success' : 'warning';
        const statusIcon = hasEPG ? 'check' : 'alert-circle';
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card card-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <span class="avatar avatar-sm bg-${statusClass}-lt me-3">
                                <i class="ti ti-${statusIcon}"></i>
                            </span>
                            <div class="flex-fill">
                                <div class="font-weight-medium">${portal.name}</div>
                                <div class="text-muted small">
                                    ${portal.channel_count} channels • ${portal.epg_channel_count} with EPG
                                </div>
                            </div>
                            <span class="badge bg-${statusClass}-lt">${hasEPG ? 'EPG OK' : 'No EPG'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function loadFallbackSettings() {
    fetch('/epg/settings', {credentials: 'same-origin'})
        .then(res => res.json())
        .then(data => {
            document.getElementById('fallbackEnabled').checked = data.epg_fallback_enabled;
            document.getElementById('fallbackCountries').value = data.epg_fallback_countries || '';
        })
        .catch(err => console.error('Error loading settings:', err));
}

function saveFallbackSettings() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Saving...';
    
    fetch('/epg/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({
            epg_fallback_enabled: document.getElementById('fallbackEnabled').checked,
            epg_fallback_countries: document.getElementById('fallbackCountries').value
        })
    })
    .then(res => res.json())
    .then(data => {
        btn.innerHTML = '<i class="ti ti-check me-1"></i>Saved!';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-device-floppy me-1"></i>Save Settings';
            btn.classList.remove('btn-success');
        }, 2000);
    })
    .catch(err => {
        console.error('Error:', err);
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-device-floppy me-1"></i>Save Settings';
    });
}

function loadEPGMapping() {
    const container = document.getElementById('epgMapping');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';
    
    fetch('/epg/channels', {credentials: 'same-origin'})
        .then(res => res.json())
        .then(data => {
            allChannels = data.channels || [];
            displayEPGMapping(allChannels);
        })
        .catch(err => {
            console.error('Error:', err);
            container.innerHTML = '<div class="alert alert-danger">Error loading channels</div>';
        });
}

function filterChannels() {
    const search = document.getElementById('channelSearch').value.toLowerCase();
    const filtered = allChannels.filter(ch => 
        ch.channel_name.toLowerCase().includes(search) ||
        ch.portal_name.toLowerCase().includes(search)
    );
    displayEPGMapping(filtered);
}

function displayEPGMapping(channels) {
    const container = document.getElementById('epgMapping');
    
    if (!channels || channels.length === 0) {
        container.innerHTML = '<div class="empty"><p class="empty-title">No channels available</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-vcenter table-sm">';
    html += '<thead><tr><th>Channel</th><th>Portal EPG</th><th>Custom EPG ID</th><th>Actions</th></tr></thead><tbody>';
    
    channels.forEach(ch => {
        const hasPortalEpg = ch.has_portal_epg;
        const hasCustomEpg = ch.epg_id && ch.epg_id.length > 0;
        
        html += `
            <tr data-portal="${ch.portal_id}" data-channel="${ch.channel_id}" data-name="${ch.channel_name}">
                <td>
                    <div class="d-flex align-items-center">
                        ${ch.logo ? `<img src="${ch.logo}" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : ''}
                        <div>
                            <div class="font-weight-medium">${ch.channel_name}</div>
                            <div class="text-muted small">${ch.portal_name} • #${ch.channel_number}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${hasPortalEpg ? 'success' : 'warning'}-lt">
                        <i class="ti ti-${hasPortalEpg ? 'check' : 'x'} me-1"></i>
                        ${hasPortalEpg ? 'Yes' : 'No'}
                    </span>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm epg-id-input" 
                           value="${ch.epg_id || ''}" placeholder="EPG ID..." style="width: 150px;">
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary save-btn" title="Save EPG ID">
                            <i class="ti ti-check"></i>
                        </button>
                        <button class="btn btn-outline-secondary fallback-btn" title="Find Fallback EPG">
                            <i class="ti ti-cloud-download"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    // Add event handlers
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const portalId = row.dataset.portal;
            const channelId = row.dataset.channel;
            const input = row.querySelector('.epg-id-input');
            saveEPGMapping(portalId, channelId, input.value, this);
        });
    });
    
    document.querySelectorAll('.fallback-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const portalId = row.dataset.portal;
            const channelId = row.dataset.channel;
            const channelName = row.dataset.name;
            applyFallback(portalId, channelId, channelName, this, row);
        });
    });
}

function saveEPGMapping(portalId, channelId, epgId, btn) {
    btn.disabled = true;
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    
    fetch('/epg/save-mapping', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({portal_id: portalId, channel_id: channelId, epg_id: epgId})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '<i class="ti ti-check"></i>';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
                btn.innerHTML = origHtml;
            }, 1500);
        } else {
            throw new Error(data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        btn.innerHTML = '<i class="ti ti-x"></i>';
        btn.classList.add('btn-danger');
        setTimeout(() => {
            btn.classList.remove('btn-danger');
            btn.innerHTML = origHtml;
        }, 2000);
    })
    .finally(() => btn.disabled = false);
}

function applyFallback(portalId, channelId, channelName, btn, row) {
    btn.disabled = true;
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    
    fetch('/epg/apply-fallback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({portal_id: portalId, channel_id: channelId, channel_name: channelName})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update the input field with the new EPG ID
            const input = row.querySelector('.epg-id-input');
            input.value = data.epg_id;
            
            btn.innerHTML = '<i class="ti ti-check"></i>';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                btn.innerHTML = origHtml;
            }, 1500);
        } else {
            throw new Error(data.error || 'No match found');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('No fallback EPG found for: ' + channelName + '\n\nMake sure fallback is enabled and countries are configured.');
        btn.innerHTML = origHtml;
    })
    .finally(() => btn.disabled = false);
}

function applyFallbackToAll(btn) {
    const channelsWithoutEpg = allChannels.filter(ch => !ch.has_portal_epg);
    
    if (channelsWithoutEpg.length === 0) {
        alert('All channels already have portal EPG!');
        return;
    }
    
    if (!confirm(`Apply fallback EPG to ${channelsWithoutEpg.length} channels without portal EPG?`)) {
        return;
    }
    
    btn.disabled = true;
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Processing...';
    
    fetch('/epg/apply-fallback-all', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({
            channels: channelsWithoutEpg.map(ch => ({
                portal_id: ch.portal_id,
                channel_id: ch.channel_id,
                channel_name: ch.channel_name
            }))
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully applied fallback to ${data.matched} out of ${data.total} channels`);
            // Reload the mapping
            loadEPGMapping();
        } else {
            throw new Error(data.error || 'Failed to apply fallback');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error applying fallback: ' + err.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = origHtml;
    });
}

function refreshEPG(btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Refreshing...';
    
    fetch('/epg/refresh', {method: 'POST', credentials: 'same-origin'})
        .then(res => res.json())
        .then(data => {
            btn.innerHTML = '<i class="ti ti-check me-1"></i>Started!';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-refresh me-1"></i>Refresh EPG';
                btn.classList.remove('btn-success');
                loadPortalEPGStatus();
            }, 2000);
        })
        .catch(err => {
            console.error('Error:', err);
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-refresh me-1"></i>Refresh EPG';
        });
}
</script>
{% endblock %}
