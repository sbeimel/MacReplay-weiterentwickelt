{% extends "base.html" %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<!-- Plyr.io CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<style>
    .copy-url-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        opacity: 0.9;
    }
    .copy-url-btn:hover {
        opacity: 1;
    }
    .duplicate-badge {
        background-color: #d63939;
        color: white;
        font-size: 0.7em;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
    }
    
    /* Custom Sorting Indicators */
    table.dataTable thead th {
        cursor: pointer;
        user-select: none;
    }
    
    table.dataTable thead th.sorting,
    table.dataTable thead th.sorting_asc,
    table.dataTable thead th.sorting_desc {
        background-image: none !important;
        padding-right: 30px !important;
    }
    
    /* Add custom sorting arrows */
    .sort-arrows {
        display: inline-block;
        margin-left: 5px;
        font-size: 0.85em;
        vertical-align: middle;
    }
    
    .sort-arrows .arrow-up,
    .sort-arrows .arrow-down {
        display: block;
        line-height: 0.7em;
        opacity: 0.25;
        transition: all 0.2s ease;
    }
    
    /* Active state for ascending sort */
    table.dataTable thead th.sorting_asc .sort-arrows .arrow-up {
        opacity: 1 !important;
        color: #206bc4 !important;
        font-weight: bold;
    }
    
    /* Active state for descending sort */
    table.dataTable thead th.sorting_desc .sort-arrows .arrow-down {
        opacity: 1 !important;
        color: #206bc4 !important;
        font-weight: bold;
    }
    /* Make table in the editor card reach to the card edges */
    .card-table-fullwidth .card-body {
        padding: 0 !important;
    }

    .card-table-fullwidth .table-responsive {
        border-radius: 0 !important;
        margin: 0;
    }

    .card-table-fullwidth .table {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <div class="page-pretitle">
                    Management
                </div>
                <h2 class="page-title">
                    <i class="ti ti-edit me-2"></i>
                    Channel Editor
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <!-- Filter Controls -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Portal</label>
                        <select class="form-select" id="portalFilter">
                            <option value="">All Portals</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Genre</label>
                        <select class="form-select" id="genreFilter">
                            <option value="">All Genres</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Duplicates</label>
                        <select class="form-select" id="duplicateFilter">
                            <option value="">All Channels</option>
                            <option value="enabled_only">Enabled Duplicates Only</option>
                            <option value="unique_only">Unique Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-warning w-100" onclick="deactivateDuplicates()" title="Deactivate enabled duplicate channels (keeps first enabled occurrence)">
                            <i class="ti ti-trash me-2"></i>Deactivate Duplicates
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-table-fullwidth">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="table" class="table table-vcenter card-table nowrap table-sm table-compact" width="100%">
        <thead>
            <tr>
                <th>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="checkbox form-check-input" onchange="editAll(this)">
                    </div>
                </th>
                <th>Play</th>
                <th>Name</th>
                <th>Genre</th>
                <th>Number</th>
                <th>EPG ID</th>
                <th title="OpenEPG Mapping Status" style="width: 60px; text-align: center;"><i class="ti ti-world"></i></th>
                <th>Fallback For</th>
                <th>Portal</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <form action="/editor/save" method="post" id="save edits" hidden>
            <input type="text" id="enabledEdits" name="enabledEdits" value="">
            <input type="text" id="numberEdits" name="numberEdits" value="">
            <input type="text" id="nameEdits" name="nameEdits" value="">
            <input type="text" id="genreEdits" name="genreEdits" value="">
            <input type="text" id="epgEdits" name="epgEdits" value="">
            <input type="text" id="fallbackEdits" name="fallbackEdits" value="">
        </form>

        <form action="/editor/reset" method="post" id="reset" hidden>
        </form>

        <!-- Channel Names Datalist for Fallback Suggestions -->
        <datalist id="channelNamesList">
            <!-- Options will be populated dynamically -->
        </datalist>

        <!-- Video Modal -->
        <div class="modal modal-blur fade" id="videoModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="channelLabel">Channel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0" style="position: relative;">
                        <button class="btn btn-primary btn-sm copy-url-btn" onclick="copyStreamUrl()" title="Copy Stream URL">
                            <i class="ti ti-copy me-1"></i>
                            Copy URL
                        </button>
                        <video id="player" playsinline controls autoplay>
                            <source src="" type="video/mp4">
                        </video>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Load jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<!-- Hls.js for better buffering -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Plyr.io JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<script>
    var enabledEdits = [];
    var numberEdits = [];
    var nameEdits = [];
    var genreEdits = [];
    var epgEdits = [];
    var fallbackEdits = [];
    var dataTable;
    var allChannelNamesCount = {}; // Track all channel name frequencies for autocomplete
    var enabledChannelNamesCount = {}; // Track enabled channel name frequencies for duplicate detection

    function editAll(ele) {
        var checkboxes = document.getElementsByClassName('checkbox');
        var enable = ele.checked;
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            if (i != 0) {
                checkboxes[i].checked = enable;
                checkboxes[i].onchange();
            }
        }
    }

    function editEnabled(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.checked;
        var j = { "portal": p, "channel id": i, "enabled": c };
        enabledEdits.push(j);
    }

    function editCustomNumber(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom number": c };
        numberEdits.push(j);
    }

    function editCustomName(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom name": c };
        nameEdits.push(j);
    }

    function editCustomGenre(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom genre": c };
        genreEdits.push(j);
    }

    function editCustomEpgId(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom epg id": c };
        epgEdits.push(j);
    }

    function editFallback(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "channel name": c };
        fallbackEdits.push(j);
    }

    function save() {
        document.getElementById("enabledEdits").value = JSON.stringify(enabledEdits);
        document.getElementById("numberEdits").value = JSON.stringify(numberEdits);
        document.getElementById("nameEdits").value = JSON.stringify(nameEdits);
        document.getElementById("genreEdits").value = JSON.stringify(genreEdits);
        document.getElementById("epgEdits").value = JSON.stringify(epgEdits);
        document.getElementById("fallbackEdits").value = JSON.stringify(fallbackEdits);
        document.getElementById("save edits").submit();
    }

    var videoElement = document.getElementById("player");
    var plyrPlayer = null;
    var hls = null;
    var currentStreamUrl = "";
    var title = document.getElementById("channelLabel");
    
    function selectChannel(ele) {
        link = ele.getAttribute('data-link');
        currentStreamUrl = link;
        channel = ele.getAttribute('data-customChannelName');
        if (channel == "") {
            channel = ele.getAttribute('data-channelName');
        }
        title.innerHTML = channel;
        
        // Clean up existing instances
        if (hls) {
            hls.destroy();
            hls = null;
        }
        
        // Initialize Plyr if not already initialized
        if (!plyrPlayer) {
            plyrPlayer = new Plyr(videoElement, {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'airplay', 'fullscreen'],
                settings: ['quality', 'speed'],
                quality: {
                    default: 720,
                    options: [1080, 720, 576, 480, 360]
                },
                volume: 0.25
            });
        }
        
        // Check if HLS is supported and if the URL is an HLS stream
        if (Hls.isSupported() && (link.includes('.m3u8') || link.includes('hls'))) {
            // Use Hls.js with aggressive buffering for smooth playback
            hls = new Hls({
                // Aggressive buffering settings
                maxBufferLength: 60,              // Buffer up to 60 seconds ahead
                maxMaxBufferLength: 120,          // Maximum buffer length
                maxBufferSize: 120 * 1000 * 1000, // 120MB buffer size
                maxBufferHole: 0.5,               // Max hole in buffer
                lowLatencyMode: false,            // Disable low latency for more buffering
                backBufferLength: 120,            // Keep 120s back buffer
                
                // Fragment loading settings
                manifestLoadingTimeOut: 20000,    // 20s timeout for manifest
                manifestLoadingMaxRetry: 6,       // Retry manifest loading
                levelLoadingTimeOut: 20000,       // 20s timeout for level loading
                levelLoadingMaxRetry: 6,          // Retry level loading
                fragLoadingTimeOut: 30000,        // 30s timeout for fragment loading
                fragLoadingMaxRetry: 10,          // Retry fragment loading more
                
                // Start loading immediately
                startPosition: -1,                // Start from live edge
                autoStartLoad: true,              // Start loading immediately
                
                // Progressive loading
                progressive: true,
                enableWorker: true,               // Use web worker for better performance
                
                // Reduce stalling
                nudgeOffset: 0.1,
                nudgeMaxRetry: 10,
                maxFragLookUpTolerance: 0.25,
                
                // ABR (Adaptive Bitrate) settings
                abrEwmaDefaultEstimate: 5000000,  // 5 Mbps default estimate
                abrBandWidthFactor: 0.95,
                abrBandWidthUpFactor: 0.7
            });
            
            hls.loadSource(link);
            hls.attachMedia(videoElement);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                plyrPlayer.play();
            });
            
            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    console.error('HLS Error:', data);
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Network error, trying to recover...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Media error, trying to recover...');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.log('Fatal error, destroying HLS instance');
                            hls.destroy();
                            break;
                    }
                }
            });
        } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
            // Native HLS support (Safari)
            videoElement.src = link;
            plyrPlayer.play();
        } else {
            // Regular video source
            plyrPlayer.source = {
                type: 'video',
                sources: [{
                    src: link,
                    type: 'video/mp4'
                }]
            };
            plyrPlayer.play();
        }
    }
    
    function copyStreamUrl() {
        if (currentStreamUrl) {
            navigator.clipboard.writeText(currentStreamUrl).then(function() {
                // Show success feedback
                const btn = document.querySelector('.copy-url-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="ti ti-check me-1"></i>Copied!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                
                setTimeout(function() {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy URL:', err);
                alert('Failed to copy URL to clipboard');
            });
        }
    }

    $('#videoModal').on('hidden.bs.modal', function () {
        if (plyrPlayer) {
            plyrPlayer.stop();
        }
        if (hls) {
            hls.destroy();
            hls = null;
        }
        currentStreamUrl = "";
    })

    /* Create an array with the values of all the checkboxes in a column */
    $.fn.dataTable.ext.order['dom-checkbox'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            return $('input', td).prop('checked') ? '1' : '0';
        });
    };

    /* Create an array with the values of all the input boxes in a column, parsed as numbers */
    $.fn.dataTable.ext.order['dom-text-numeric'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            var val = $('input', td).val();
            return val === '' ? $('input', td).attr('placeholder') : val * 1;
        });
    };

    /* Create an array with the values of all the text boxes in a column */
    $.fn.dataTable.ext.order['dom-text'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            var val = $('input', td).val();
            return val === '' ? $('input', td).attr('placeholder') : val;
        });
    };

    // Populate filter dropdowns
    function populateFilters() {
        // Populate portals dropdown
        fetch('/editor/portals')
            .then(res => {
                console.log('Portals response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Portals data:', data);
                const select = document.getElementById('portalFilter');
                if (data.portals && data.portals.length > 0) {
                    data.portals.forEach(portal => {
                        const option = document.createElement('option');
                        option.value = portal;
                        option.textContent = portal;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('No portals returned');
                }
            })
            .catch(err => console.error('Error loading portals:', err));

        // Populate genres dropdown
        fetch('/editor/genres')
            .then(res => {
                console.log('Genres response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('Genres data:', data);
                const select = document.getElementById('genreFilter');
                if (data.genres && data.genres.length > 0) {
                    data.genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre;
                        option.textContent = genre;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('No genres returned');
                }
            })
            .catch(err => console.error('Error loading genres:', err));
    }

    $(document).ready(function () {
        // Populate filter dropdowns
        populateFilters();

        dataTable = $('#table').DataTable({
            dom: "<'row m-1'<'col-auto'B><'col-auto ms-auto'f><'col-auto'l>>" +
                "<'row'<'col-12'tr>>" +
                "<'row mb-1 mb-lg-0'<'col-auto text-light'i><'col-auto ms-auto'p>>",
            serverSide: true,
            processing: true,
            order: [[0, 'desc'], [2, 'asc']],
            pageLength: 250,
            lengthMenu: [[25, 50, 100, 250, 500, 1000], [25, 50, 100, 250, 500, 1000]],
            columnDefs: [
                { targets: [0, 1], width: "0%" },
                { targets: 0, className: "align-middle", orderable: false, searchable: false },
                { targets: 1, className: "align-middle", orderable: false, searchable: false },
                { targets: 2, className: "align-middle", type: 'string' },
                { targets: 3, className: "align-middle", type: 'string' },
                { targets: 4, className: "align-middle" },
                { targets: 5, className: "align-middle", type: 'string' },
                { targets: 6, className: "align-middle", type: 'string' },
                { targets: 7, className: "align-middle" }
            ],
            language: {
                search: "",
                searchPlaceholder: 'Filter',
                lengthMenu: "_MENU_",
                processing: "Loading channels..."
            },
            buttons: {
                buttons: [
                    {
                        text: '<i class="ti ti-device-floppy me-2"></i>Save',
                        titleAttr: 'Save',
                        className: "btn btn-success",
                        action: function () {
                            save();
                        }
                    },
                    {
                        text: '<i class="ti ti-refresh me-2"></i>Refresh Channels',
                        titleAttr: 'Refresh channel list from portal',
                        className: "btn btn-primary",
                        action: function () {
                            refreshChannels();
                        }
                    },
                    {
                        text: '<i class="ti ti-rotate-clockwise me-2"></i>Reset',
                        titleAttr: 'Reset',
                        className: "btn btn-danger",
                        action: function () {
                            if (confirm("Confirm Reset\nThis will clear all edits!") == true) {
                                document.getElementById('reset').submit();
                            }
                        }
                    }
                ],
            },
            ajax: {
                "url": "/editor_data",
                "dataType": "json",
                "contentType": "application/json",
                "data": function(d) {
                    // Add custom filter parameters
                    d.portal = $('#portalFilter').val();
                    d.genre = $('#genreFilter').val();
                    d.duplicates = $('#duplicateFilter').val();
                }
            },
            columns: [
                {
                    data: "enabled",
                    render: function (data, type, row, meta) {
                        let r = '<div \
                                class="form-check form-switch">\
                                <input \
                                type="checkbox" \
                                class="checkbox form-check-input" \
                                onchange="editEnabled(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '"'
                        if (data == true) {
                            r = r + ' checked';
                        }
                        r = r + '></div>'
                        return r
                    }
                },
                {
                    data: "link",
                    render: function (data, type, row, meta) {
                        return '<button \
                            class="btn btn-success btn-sm btn-icon" \
                            title="Play" \
                            data-bs-toggle="modal" \
                            data-bs-target="#videoModal" \
                            onclick="selectChannel(this)" \
                            data-channelName="' + row.channelName + '" \
                            data-customChannelName="' + row.customChannelName + '" \
                            data-link="' + row.link + '">\
                            <i class="ti ti-player-play"></i>\
                        </button>'
                    }
                },
                {
                    data: "channelName",
                    render: function (data, type, row, meta) {
                        var duplicateBadge = '';
                        if (row.duplicateCount && row.duplicateCount > 1) {
                            duplicateBadge = '<span class="duplicate-badge">' + row.duplicateCount + 'x enabled</span>';
                        }
                        return '<div style="display: flex; align-items: center; gap: 5px;">' +
                               '<input \
                                type="text" \
                                class="form-control" \
                                style="min-width: 200px;" \
                                onchange="editCustomName(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.channelName + '" \
                                title="' + row.channelName + '" \
                                value="' + row.customChannelName + '">' +
                               duplicateBadge +
                               '</div>';
                    },
                },
                {
                    data: "genre",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="min-width: 200px;" \
                                onchange="editCustomGenre(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.genre + '" \
                                title="' + row.genre + '" \
                                value="' + row.customGenre + '">'
                    },
                },
                {
                    data: "channelNumber",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="min-width: 100px;" \
                                onchange="editCustomNumber(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.channelNumber + '" \
                                title="' + row.channelNumber + '" \
                                value="' + row.customChannelNumber + '">'
                    },
                },
                {
                    data: "channelId",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="min-width: 200px;" \
                                onchange="editCustomEpgId(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.portal + row.channelId + '" \
                                title="' + row.portal + row.channelId + '" \
                                value="' + row.customEpgId + '">'
                    },
                },
                {
                    data: "openepgName",
                    orderable: false,
                    className: "text-center",
                    render: function (data, type, row, meta) {
                        if (data && data.trim() !== '') {
                            return '<span class="badge bg-success" title="Mapped to: ' + data + '" style="cursor: help;">' + 
                                   '<i class="ti ti-check"></i>' +
                                   '</span>';
                        } else {
                            return '<span class="text-muted" title="Not mapped to OpenEPG" style="cursor: help;">-</span>';
                        }
                    },
                },
                {
                    data: "fallbackChannel",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="min-width: 200px;" \
                                list="channelNamesList" \
                                placeholder="Enter channel name..." \
                                title="Type to search or click to see all channel names" \
                                onchange="editFallback(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                value="' + row.fallbackChannel + '">'
                    }
                },
                { data: "portalName" },
            ],
        });

        // Add filter change event handlers
        $('#portalFilter, #genreFilter, #duplicateFilter').on('change', function() {
            dataTable.ajax.reload();
        });
        
        // Add sorting arrows to table headers (after table is initialized)
        setTimeout(function() {
            $('#table thead th').each(function() {
                const $th = $(this);
                if (!$th.hasClass('sorting_disabled')) {
                    $th.append('<span class="sort-arrows" style="display: inline-block; margin-left: 5px; font-size: 0.85em; vertical-align: middle;"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></span>');
                }
            });
        }, 100);
    });
    
    // Function to deactivate duplicate enabled channels
    function deactivateDuplicates() {
        if (!confirm('This will deactivate all duplicate enabled channels, keeping only the first occurrence of each. Continue?')) {
            return;
        }

        fetch('/editor/deactivate-duplicates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Successfully deactivated ' + data.deactivated + ' duplicate channels!');
                dataTable.ajax.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deactivating duplicates: ' + error);
        });
    }

    // Function to refresh channels from portal
    function refreshChannels() {
        if (!confirm('This will fetch the latest channel list from your portals. This may take a few minutes. Continue?')) {
            return;
        }
        
        // Show loading indicator
        var btn = $('.btn-primary').first();
        var originalText = btn.html();
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...').prop('disabled', true);
        
        fetch('/editor/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Successfully refreshed ' + data.total + ' channels!');
                dataTable.ajax.reload();
            } else {
                alert('Error refreshing channels: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error refreshing channels: ' + error);
        })
        .finally(() => {
            btn.html(originalText).prop('disabled', false);
        });
    }

</script>
{% endblock %} 