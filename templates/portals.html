{% extends "base.html" %}

{% block title %}Portals - MacReplay{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-antenna me-2"></i>
                    Portal Management
                </h2>
                <div class="text-muted mt-1">Manage your IPTV portals and MAC addresses</div>
            </div>
            <div class="col-auto ms-auto">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPortalModal">
                    <i class="ti ti-plus me-1"></i>
                    Add Portal
                </button>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">

        {% if portals %}
        <div class="row row-cards">
            {% for portal_id, portal in portals.items() %}
            <div class="col-md-6 col-lg-4">
                <div class="card">
                    <div class="card-status-top bg-{{ 'success' if portal.enabled == 'true' else 'secondary' }}"></div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-fill">
                                <h3 class="card-title mb-1">{{ portal.name or 'Unnamed Portal' }}</h3>
                                <div class="text-muted small text-truncate">
                                    {{ portal.url[:50] }}{% if portal.url|length > 50 %}...{% endif %}
                                </div>
                            </div>
                            <span class="badge bg-{{ 'success' if portal.enabled == 'true' else 'secondary' }} ms-2">
                                {{ 'Enabled' if portal.enabled == 'true' else 'Disabled' }}
                            </span>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="text-muted small">MAC Addresses</div>
                                <div class="h3 mb-0">{{ portal.macs|length }}</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">Streams/MAC</div>
                                <div class="h3 mb-0">{{ portal['streams per mac'] }}</div>
                            </div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-muted small">EPG Offset</div>
                                <div>{{ portal['epg offset'] }} hours</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">Enabled Channels</div>
                                <div>{{ portal.get('enabled channels', [])|length }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="btn-list">
                            <button class="btn btn-outline-success btn-sm" onclick="selectGenres('{{ portal_id }}', '{{ portal.name }}')">
                                <i class="ti ti-filter me-1"></i>
                                Genres
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="editPortal('{{ portal_id }}')">
                                <i class="ti ti-edit me-1"></i>
                                Edit
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deletePortal('{{ portal_id }}', '{{ portal.name }}')">
                                <i class="ti ti-trash me-1"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty">
            <div class="empty-icon">
                <i class="ti ti-antenna icon"></i>
            </div>
            <p class="empty-title">No portals configured</p>
            <p class="empty-subtitle text-muted">
                Add your first portal to get started with MacReplay
            </p>
            <div class="empty-action">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPortalModal">
                    <i class="ti ti-plus me-1"></i>
                    Add your first portal
                </button>
            </div>
        </div>
        {% endif %}

<!-- Add Portal Modal -->
<div class="modal modal-blur fade" id="addPortalModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="POST" action="/portal/add">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="ti ti-plus me-2"></i>Add New Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required" for="name">Portal Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="My IPTV Portal" required aria-required="true" aria-describedby="name-hint">
                        <small id="name-hint" class="form-hint">A friendly name for this portal</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required" for="url">Portal URL</label>
                        <div class="input-icon">
                            <span class="input-icon-addon" aria-hidden="true">
                                <i class="ti ti-link"></i>
                            </span>
                            <input type="url" class="form-control" id="url" name="url" placeholder="http://portal.example.com" required aria-required="true" aria-describedby="url-hint">
                        </div>
                        <small id="url-hint" class="form-hint">Enter the portal domain or full URL</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required" for="macs">MAC Addresses</label>
                        <textarea class="form-control" id="macs" name="macs" rows="4" placeholder="00:1A:79:XX:XX:XX&#10;00:1A:79:YY:YY:YY&#10;00:1A:79:ZZ:ZZ:ZZ" required aria-required="true" aria-describedby="macs-hint"></textarea>
                        <small id="macs-hint" class="form-hint">Enter MAC addresses (one per line). Formats: 00:1A:79:XX:XX:XX or 00-1A-79-XX-XX-XX</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Streams per MAC</label>
                                <input type="number" class="form-control" id="streams_per_mac" name="streams per mac" value="1" min="0" max="10">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">EPG Offset (hours)</label>
                                <input type="number" class="form-control" id="epg_offset" name="epg offset" value="0" min="-12" max="12">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Proxy <span class="form-label-description">Optional</span></label>
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <i class="ti ti-server"></i>
                            </span>
                            <input type="text" class="form-control" id="proxy" name="proxy" placeholder="http://proxy:port">
                        </div>
                        <small class="form-hint">Leave empty if no proxy needed</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary ms-auto" id="addPortalBtn">
                        <i class="ti ti-plus me-1"></i>
                        Add Portal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Portal Modal -->
<div class="modal modal-blur fade" id="editPortalModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <form method="POST" action="/portal/update" id="editPortalForm">
                <input type="hidden" id="edit_portal_id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="ti ti-edit me-2"></i>Edit Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_enabled" name="enabled" value="true">
                            <span class="form-check-label">Portal Enabled</span>
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Portal Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Portal URL</label>
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <i class="ti ti-link"></i>
                            </span>
                            <input type="url" class="form-control" id="edit_url" name="url" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current MAC Addresses</label>
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-sm table-vcenter card-table" id="editMacTable">
                                    <tbody id="editMacTableBody">
                                        <!-- MACs will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Update MAC Addresses</label>
                        <textarea class="form-control" id="edit_macs" name="macs" rows="4" required></textarea>
                        <small class="form-hint">Enter MAC addresses (one per line)</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Streams per MAC</label>
                                <input type="number" class="form-control" id="edit_streams_per_mac" name="streams per mac" min="0" max="10">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">EPG Offset (hours)</label>
                                <input type="number" class="form-control" id="edit_epg_offset" name="epg offset" min="-12" max="12">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Proxy <span class="form-label-description">Optional</span></label>
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <i class="ti ti-server"></i>
                            </span>
                            <input type="text" class="form-control" id="edit_proxy" name="proxy">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="retest" name="retest" value="true">
                            <span class="form-check-label">Retest all MAC addresses</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary ms-auto">
                        <i class="ti ti-device-floppy me-1"></i>
                        Update Portal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Portal Modal -->
<div class="modal modal-blur fade" id="deletePortalModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <form method="POST" action="/portal/remove">
                <input type="hidden" id="delete_portal_id" name="deleteId">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="modal-status bg-danger"></div>
                <div class="modal-body text-center py-4">
                    <i class="ti ti-alert-triangle icon mb-2 text-danger icon-lg"></i>
                    <h3>Are you sure?</h3>
                    <div class="text-muted">Do you really want to delete the portal "<span id="delete_portal_name"></span>"? This action cannot be undone.</div>
                </div>
                <div class="modal-footer">
                    <div class="w-100">
                        <div class="row">
                            <div class="col">
                                <button type="button" class="btn w-100" data-bs-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                            <div class="col">
                                <button type="submit" class="btn btn-danger w-100">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Genre Selection Modal -->
<div class="modal modal-blur fade" id="genreSelectionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="ti ti-filter"></i> Select Genres for <span id="genre_portal_name"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <i class="ti ti-search"></i>
                            </span>
                            <input type="text" class="form-control" id="genreSearchInput" placeholder="Search genres..." onkeyup="filterGenres()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 justify-content-end">
                            <span class="badge bg-primary align-self-center"><span id="selectedGenreCount">0</span> selected</span>
                            <span class="badge bg-secondary align-self-center"><span id="visibleGenreCount">0</span> visible</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllGenresModal()">
                                <i class="ti ti-check me-1"></i>
                                All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllGenresModal()">
                                <i class="ti ti-x me-1"></i>
                                None
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="genreLoadingMessage" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading genres from portal...</p>
                </div>
                
                <div id="genreListContainer" style="display: none;">
                    <div class="row row-cards" id="genreList">
                        <!-- Genres will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary ms-auto" onclick="saveGenreSelectionModal()" id="saveGenresBtn">
                    <i class="ti ti-device-floppy"></i> Save and Enable Channels
                </button>
            </div>
        </div>
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const portalsData = {{ portals | tojson }};

// Auto-open genre modal if portal was just added
{% if show_genre_modal and genre_modal_portal_id %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        selectGenres('{{ genre_modal_portal_id }}', '{{ genre_modal_portal_name }}');
    }, 500);
});
{% endif %}

function editPortal(portalId) {
    const portal = portalsData[portalId];
    if (!portal) return;
    
    document.getElementById('edit_portal_id').value = portalId;
    document.getElementById('edit_enabled').checked = portal.enabled === 'true';
    document.getElementById('edit_name').value = portal.name;
    document.getElementById('edit_url').value = portal.url;
    document.getElementById('edit_macs').value = Object.keys(portal.macs).join('\n');
    document.getElementById('edit_streams_per_mac').value = portal['streams per mac'];
    document.getElementById('edit_epg_offset').value = portal['epg offset'];
    document.getElementById('edit_proxy').value = portal.proxy || '';
    
    // Populate MAC table with expiry dates
    const macTableBody = document.getElementById('editMacTableBody');
    macTableBody.innerHTML = '';
    
    const now = Date.now();
    for (const [mac, expiry] of Object.entries(portal.macs)) {
        const row = document.createElement('tr');
        const expires = Date.parse(expiry);
        const diff = expires - now;
        const daysAway = diff / (1000 * 3600 * 24);
        
        // Add color coding
        if (now > expires) {
            row.classList.add('table-danger');
        } else if (daysAway < 30) {
            row.classList.add('table-warning');
        }
        
        row.innerHTML = `
            <td><code>${mac.toUpperCase()}</code></td>
            <td>:</td>
            <td>${expiry}</td>
        `;
        macTableBody.appendChild(row);
    }
    
    new bootstrap.Modal(document.getElementById('editPortalModal')).show();
}

function deletePortal(portalId, portalName) {
    document.getElementById('delete_portal_id').value = portalId;
    document.getElementById('delete_portal_name').textContent = portalName;
    
    new bootstrap.Modal(document.getElementById('deletePortalModal')).show();
}

let currentPortalId = null;
let genresData = [];
let selectedGenresSet = new Set();

function selectGenres(portalId, portalName) {
    currentPortalId = portalId;
    document.getElementById('genre_portal_name').textContent = portalName;
    
    // Reset state
    selectedGenresSet.clear();
    genresData = [];
    document.getElementById('genreLoadingMessage').style.display = 'block';
    document.getElementById('genreListContainer').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('genreSelectionModal'));
    modal.show();
    
    // Load genres
    fetch('/portal/load-genres', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ portal_id: portalId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert('Error loading genres: ' + data.error);
            modal.hide();
            return;
        }
        
        genresData = data.genres;
        
        // Pre-select enabled genres
        selectedGenresSet.clear();
        if (data.enabled_genres && data.enabled_genres.length > 0) {
            console.log('Pre-selecting genres:', data.enabled_genres);
            data.enabled_genres.forEach(genre => selectedGenresSet.add(genre));
            console.log('Selected genres set size:', selectedGenresSet.size);
        }
        
        renderGenresModal();
        
        document.getElementById('genreLoadingMessage').style.display = 'none';
        document.getElementById('genreListContainer').style.display = 'block';
    })
    .catch(err => {
        console.error('Error loading genres:', err);
        alert('Error loading genres: ' + err);
        modal.hide();
    });
}

function renderGenresModal() {
    const container = document.getElementById('genreList');
    container.innerHTML = '';
    
    genresData.forEach(genre => {
        const col = document.createElement('div');
        col.className = 'col-sm-6 col-md-4 col-lg-3';
        
        // Check if this genre is selected
        const isSelected = selectedGenresSet.has(genre.name);
        
        const card = document.createElement('div');
        card.className = 'card card-sm';
        if (isSelected) {
            card.classList.add('card-active');
        }
        card.style.cursor = 'pointer';
        card.onclick = () => toggleGenreModal(genre.name);
        
        card.innerHTML = `
            <div class="card-body p-2">
                <div class="d-flex align-items-start">
                    <div class="form-check mb-0 mt-1">
                        <input class="form-check-input genre-checkbox" type="checkbox" id="genre_${escapeHtml(genre.name)}" data-genre="${escapeHtml(genre.name)}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation()">
                    </div>
                    <div class="ms-2 flex-fill" style="min-width: 0;">
                        <div class="text-break" style="font-size: 0.875rem; line-height: 1.3;" title="${escapeHtml(genre.name)}">${escapeHtml(genre.name)}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${genre.count} channels</div>
                    </div>
                    ${isSelected ? '<div class="ms-2 flex-shrink-0"><i class="ti ti-check text-success"></i></div>' : ''}
                </div>
            </div>
        `;
        
        col.appendChild(card);
        container.appendChild(col);
    });
    
    console.log('Rendered', genresData.length, 'genres,', selectedGenresSet.size, 'selected');
    updateSelectedGenreCount();
}

function toggleGenreModal(genreName) {
    if (selectedGenresSet.has(genreName)) {
        selectedGenresSet.delete(genreName);
    } else {
        selectedGenresSet.add(genreName);
    }
    
    updateGenreUIModal();
}

function selectAllGenresModal() {
    // Select only visible genres
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        const col = checkbox.closest('.col-sm-6');
        if (col && col.style.display !== 'none') {
            const genreName = checkbox.dataset.genre;
            selectedGenresSet.add(genreName);
        }
    });
    updateGenreUIModal();
}

function deselectAllGenresModal() {
    // Deselect only visible genres
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        const col = checkbox.closest('.col-sm-6');
        if (col && col.style.display !== 'none') {
            const genreName = checkbox.dataset.genre;
            selectedGenresSet.delete(genreName);
        }
    });
    updateGenreUIModal();
}

function filterGenres() {
    const searchTerm = document.getElementById('genreSearchInput').value.toLowerCase();
    let visibleCount = 0;
    
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        const genreName = checkbox.dataset.genre.toLowerCase();
        const col = checkbox.closest('[class*="col-"]');
        
        if (genreName.includes(searchTerm)) {
            col.style.display = '';
            visibleCount++;
        } else {
            col.style.display = 'none';
        }
    });
    
    document.getElementById('visibleGenreCount').textContent = visibleCount;
}

function updateGenreUIModal() {
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        const genreName = checkbox.dataset.genre;
        const isSelected = selectedGenresSet.has(genreName);
        checkbox.checked = isSelected;
        
        // Update card styling
        const card = checkbox.closest('.card');
        if (isSelected) {
            card.classList.add('card-active');
            // Add checkmark if not exists
            if (!card.querySelector('.ti-check')) {
                const checkIcon = document.createElement('div');
                checkIcon.className = 'ms-auto';
                checkIcon.innerHTML = '<i class="ti ti-check text-success"></i>';
                card.querySelector('.d-flex').appendChild(checkIcon);
            }
        } else {
            card.classList.remove('card-active');
            // Remove checkmark
            const checkIcon = card.querySelector('.ms-auto');
            if (checkIcon && checkIcon.querySelector('.ti-check')) {
                checkIcon.remove();
            }
        }
    });
    
    updateSelectedGenreCount();
}

function updateSelectedGenreCount() {
    document.getElementById('selectedGenreCount').textContent = selectedGenresSet.size;
    
    // Count visible genres
    let visibleCount = 0;
    document.querySelectorAll('.genre-checkbox').forEach(checkbox => {
        const col = checkbox.closest('.col-sm-6');
        if (col && col.style.display !== 'none') {
            visibleCount++;
        }
    });
    document.getElementById('visibleGenreCount').textContent = visibleCount;
}

function saveGenreSelectionModal() {
    if (selectedGenresSet.size === 0) {
        if (!confirm('No genres selected. This means no channels will be enabled. Continue?')) {
            return;
        }
    }
    
    const saveBtn = document.getElementById('saveGenresBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    fetch('/portal/save-genre-selection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            portal_id: currentPortalId,
            selected_genres: Array.from(selectedGenresSet),
            auto_sync: false
        })
    })
    .then(res => res.json())
    .then(data => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        
        if (data.error) {
            alert('Error saving: ' + data.error);
            return;
        }
        
        alert(`Successfully enabled ${data.enabled_count} out of ${data.total_count} channels!`);
        bootstrap.Modal.getInstance(document.getElementById('genreSelectionModal')).hide();
        
        // Optionally redirect to editor
        if (confirm('Channels have been enabled. Go to the editor to view them?')) {
            window.location.href = '/editor';
        }
    })
    .catch(err => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        console.error('Error saving:', err);
        alert('Error saving: ' + err);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add loading state to form submission
document.getElementById('addPortalModal')?.querySelector('form')?.addEventListener('submit', function(e) {
    const btn = document.getElementById('addPortalBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
    }
});

// Validate MAC addresses on input
document.getElementById('macs')?.addEventListener('blur', function() {
    const macs = this.value.split('\n').filter(m => m.trim());
    const macPattern = /^([0-9A-Fa-f]{2}[:-]?){5}([0-9A-Fa-f]{2})$/;
    const invalidMacs = macs.filter(mac => !macPattern.test(mac.trim()));
    
    if (invalidMacs.length > 0) {
        this.setCustomValidity('Invalid MAC address format: ' + invalidMacs.join(', '));
        this.reportValidity();
    } else {
        this.setCustomValidity('');
    }
});

// Validate URL on input
document.getElementById('url')?.addEventListener('blur', function() {
    const urlPattern = /^https?:\/\/.+/;
    if (this.value && !urlPattern.test(this.value)) {
        this.setCustomValidity('URL must start with http:// or https://');
        this.reportValidity();
    } else {
        this.setCustomValidity('');
    }
});
</script>
{% endblock %} 